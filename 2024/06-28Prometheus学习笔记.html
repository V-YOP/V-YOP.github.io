

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="友纪V-λOP">
  <meta name="keywords" content="">
  
    <meta name="description" content="普罗米修斯，后面简称 prom，是一个分布式的监控平台，它有自己的服务端，通拉模式从各种客户端，如 spring 应用，中间件，mysql 等拉取信息，各种 exporter 是客户端和 prom 之间的 adapter。项目用到了 prom，所以这里学习一下做个笔记。">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus 学习笔记">
<meta property="og:url" content="http://example.com/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">
<meta property="og:site_name" content="友纪V-λOP">
<meta property="og:description" content="普罗米修斯，后面简称 prom，是一个分布式的监控平台，它有自己的服务端，通拉模式从各种客户端，如 spring 应用，中间件，mysql 等拉取信息，各种 exporter 是客户端和 prom 之间的 adapter。项目用到了 prom，所以这里学习一下做个笔记。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-4.png">
<meta property="og:image" content="http://example.com/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-1.png">
<meta property="og:image" content="http://example.com/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-2.png">
<meta property="article:published_time" content="2024-06-28T08:00:00.000Z">
<meta property="article:modified_time" content="2024-06-28T07:54:56.001Z">
<meta property="article:author" content="友纪V-λOP">
<meta property="article:tag" content="Prometheus">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-4.png">
  
  
  <title>Prometheus 学习笔记 - 友纪V-λOP</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/atom-one-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss2.xml" title="友纪V-λOP" type="application/rss+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>友纪V-λOP的blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Prometheus 学习笔记">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2024-06-28 16:00" pubdate>
        2024年6月28日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      22k 字
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Prometheus 学习笔记</h1>
            
            <div class="markdown-body">
              <p>普罗米修斯，后面简称 prom，是一个分布式的监控平台，它有自己的服务端，通过<strong>拉</strong>模式从各种客户端，如 spring 应用，中间件，mysql 等拉取信息，各种 exporter 是客户端和 prom 之间的 adapter。项目用到了 prom，所以这里学习一下做个笔记。</p>
<p>这篇笔记包括：</p>
<ol>
<li>prom，grafana，alertmanager 环境搭建</li>
<li>node-exporter，nginx-prometheus-exporter, prometheus-nginxlog-exporter，blackbox-exporter 环境搭建和集成</li>
<li><del>redis exporter, mysql exporter 环境搭建和集成</del></li>
<li>alertmanager 环境搭建，集成和使用</li>
<li>PromQL 入门和示例</li>
</ol>
<p><img src="/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-4.png" alt="alt text"></p>
<h1 id="prom-grafana"><a href="#prom-grafana" class="headerlink" title="prom, grafana"></a>prom, grafana</h1><p>grafana 是 prom 的<strong>客户端</strong>，它从 prom 上拉数据去展示，<strong>prom 不知晓 grafana</strong>。</p>
<p>直接上 docker，使用 grafana 去连上 prom：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">prometheus:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./prometheus.yml:/etc/prometheus/prometheus.yml</span><br><span class="hljs-comment">#            - ./node_down.yml:/usr/local/etc/node_down.yml:rw</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9090:9090&quot;</span><br>  <span class="hljs-attr">grafana:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">grafana</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">grafana</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3000:3000&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>其中 prom 配置文件内容为：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">global:</span><br>  <span class="hljs-attr">scrape_interval:</span>     <span class="hljs-string">15s</span><br>  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-comment"># 监控 prometheus 自己</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;prometheus&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;172.17.0.1:9090&#x27;</span>] <span class="hljs-comment"># 172.17.0.1 总是宿主机</span><br></code></pre></div></td></tr></table></figure>



<p><strong>job 是实例 instance 的集合，实例是监控的最小单元，任何指标都会被赋予 job 和 instance 标签去标识它来自哪个实例</strong>。</p>
<p>执行 <code>docker compose up -d</code>，访问 grafana<code>localhost:3000</code>  <code>admin/admin</code>，在 connection 中添加 prom 的数据源，然后添加一个 dashboard，添加一个 code query：</p>
<figure class="highlight ruby"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ruby">up&#123;job=<span class="hljs-string">&quot;prometheus&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h1><p>参考 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/overview/">https://prometheus.io/docs/alerting/latest/overview/</a>。</p>
<p>prom 负责拉取和存储数据，并在出现问题时推送告警给 alertmanager，alertmanager 将告警去重，分组，路由到特定处理逻辑。<strong>prom 知晓 alertmanager</strong>，alertmanager 不知晓 prom。</p>
<blockquote>
<p>The main steps to setting up alerting and notifications are:</p>
<ul>
<li>Setup and configure the Alertmanager</li>
<li>Configure Prometheus to talk to the Alertmanager</li>
<li>Create alerting rules in Prometheus</li>
</ul>
</blockquote>
<p>部署 alertmanager 的 docker compose 如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">alertmanager:</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">prom/alertmanager</span><br>  <span class="hljs-attr">container_name:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">hostname:</span> <span class="hljs-string">alertmanager</span><br>  <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>  <span class="hljs-attr">environment:</span><br>    <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9093:9093&quot;</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./alertmanager:/config&quot;</span><br>  <span class="hljs-attr">command:</span> <span class="hljs-string">--config.file=/config/alertmanager.yml</span> <span class="hljs-string">--log.level=info</span><br></code></pre></div></td></tr></table></figure>

<p>alertmanager 需要配置告警路由和接受者：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-comment"># ./alertmanager/alertmanager.yml</span><br><br><span class="hljs-comment"># 根路由，必须匹配所有告警</span><br><span class="hljs-attr">route:</span><br>  <span class="hljs-attr">receiver:</span> <span class="hljs-string">&#x27;dingtalk&#x27;</span><br>  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">1h</span> <span class="hljs-comment"># 告警间隔 1h 才会发一次，resolved 消息不受此限制</span><br>  <span class="hljs-attr">group_by:</span> [ <span class="hljs-string">serverity</span>, <span class="hljs-string">alertname</span> ]<br><br><span class="hljs-attr">receivers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;dingtalk&#x27;</span><br>    <span class="hljs-attr">webhook_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">&#x27;钉钉 webhook&#x27;</span><br>        <span class="hljs-attr">send_resolved:</span> <span class="hljs-literal">true</span>   <br></code></pre></div></td></tr></table></figure>

<p>关于路由和接受者的配置见 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/configuration/#route">https://prometheus.io/docs/alerting/latest/configuration/#route</a> 和 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/configuration/#receiver">https://prometheus.io/docs/alerting/latest/configuration/#receiver</a>。路由是一个树结构，根节点必须匹配所有告警。后续有需要再研究。</p>
<h2 id="prom-告警配置"><a href="#prom-告警配置" class="headerlink" title="prom 告警配置"></a>prom 告警配置</h2><p>prom 主动推送告警给 alertmanager，因此<strong>需配置 prom 去知晓 alertmanager</strong>，以及<strong>配置 prom 的告警规则</strong>：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-comment"># prometheus.yml</span><br><br><span class="hljs-comment"># 告警规则文件</span><br><span class="hljs-attr">rule_files:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/etc/prometheus/rules/*.yml&quot;</span><br><br><span class="hljs-comment"># 告警处理者，即 alertmanager</span><br><span class="hljs-attr">alerting:</span><br>  <span class="hljs-attr">alertmanagers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">scheme:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">static_configs:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [ <span class="hljs-string">&#x27;alertmanager:9093&#x27;</span> ]<br></code></pre></div></td></tr></table></figure>

<p>以及需要配置告警规则：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">groups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">实例存活告警规则</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">实例存活告警</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">up</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">for:</span> <span class="hljs-string">30s</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">serverity:</span> <span class="hljs-string">Disaster</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;节点失联&quot;</span><br>          <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;节点断联已超过 1 分钟&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">内存告警规则</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">&quot;内存使用率告警&quot;</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">round((node_memory_MemTotal_bytes</span> <span class="hljs-bullet">-</span> <span class="hljs-string">(node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes</span> <span class="hljs-string">))</span> <span class="hljs-string">/</span> <span class="hljs-string">node_memory_MemTotal_bytes</span> <span class="hljs-string">*</span> <span class="hljs-number">100</span><span class="hljs-string">,1)</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">75</span>    <span class="hljs-comment"># 告警阈值为当内存使用率大于 75%</span><br>        <span class="hljs-attr">for:</span> <span class="hljs-string">30s</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;服务器内存报警&quot;</span><br>          <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;内存资源利用率大于 75%！（当前值：<span class="hljs-template-variable">&#123;&#123; $value &#125;&#125;</span>%)&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">端点断连告警规则</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">端点断连告警</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">probe_success</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">serverity:</span> <span class="hljs-string">Disaster</span><br>        <span class="hljs-attr">for:</span> <span class="hljs-string">30s</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;端点断连告警&quot;</span><br>          <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;端点断连已超过 1 分钟&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>prom 会对每个告警规则的 expr 求值，如果求值得到的瞬时向量<strong>非空</strong>且持续 for 中指定的时间，则认为需要告警，推送给 alertmanager。alertmanager 再推送给钉钉等接受者。</p>
<h2 id="钉钉告警配置"><a href="#钉钉告警配置" class="headerlink" title="钉钉告警配置"></a>钉钉告警配置</h2><p>TODO</p>
<h1 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node-exporter"></a>node-exporter</h1><p>node-exporter 检测物理机的资源占用情况，因此需要进行本机安装。node-exporter 监听 9100 端口。</p>
<p>直接执行该 sh 即可安装：</p>
<figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh"><span class="hljs-meta">#!/bin/bash</span><br><br>wget https://kkgithub.com/prometheus/node_exporter/releases/download/v1.8.1/node_exporter-1.8.1.linux-amd64.tar.gz<br><br>tar xvfz node_exporter-1.8.1.linux-amd64.tar.gz<br><br>sudo <span class="hljs-built_in">mv</span> node_exporter-1.8.1.linux-amd64/node_exporter /usr/local/bin<br><br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt;/usr/lib/systemd/system/node_exporter.service</span><br><span class="hljs-string">[Unit]</span><br><span class="hljs-string">Descrption=https://prometheus.io</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Service]</span><br><span class="hljs-string">Restart=on-failure</span><br><span class="hljs-string">ExecStart=/usr/local/bin/node_exporter --collector.systemd.unit-whitelist=(docker|kubelet|kube-proxy|flanneld).service</span><br><span class="hljs-string"></span><br><span class="hljs-string">[Install]</span><br><span class="hljs-string">WantedBy=multi-user.target</span><br><span class="hljs-string">EOF</span><br><br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> node_exporter<br>systemctl restart node_exporter<br></code></pre></div></td></tr></table></figure>

<p>此时<code>curl localhost:9100/metrics</code>便能看到结果。</p>
<p>在<code>prometheus.yml</code>下配置相应 job：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;some_node_exporter&#x27;</span><br>  <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;IP:9100&#x27;</span>]<br></code></pre></div></td></tr></table></figure>

<h1 id="nginx-exporter"><a href="#nginx-exporter" class="headerlink" title="nginx-exporter"></a>nginx-exporter</h1><p>nginx 的 exporter 有两个：</p>
<ul>
<li>nginx-prometheus-exporter，访问 nginx 直接暴露出来的接口获取指标，它可以部署在任意机器上</li>
<li>prometheus-nginxlog-exporter，修改 nginx 的访问日志格式，通过分析日志去得到各种类型请求的情况，需要部署在 nginx 所在机器上</li>
</ul>
<h2 id="nginx-prometheus-exporter"><a href="#nginx-prometheus-exporter" class="headerlink" title="nginx-prometheus-exporter"></a>nginx-prometheus-exporter</h2><p>参照 <a target="_blank" rel="noopener" href="https://blog.csdn.net/zls365365/article/details/134623254">https://blog.csdn.net/zls365365/article/details/134623254</a>。</p>
<p>nginx 自己有配置能暴露出当前状态为 HTTP 接口，但要和 prom 集成需要一个所谓的 <code>nginx-prometheus-exporter</code>去转换它的格式。</p>
<p>首先需要配置 nginx，在 nginx.conf 中加入：</p>
<figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /nginx_status &#123;<br>    <span class="hljs-attribute">stub_status</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;<br>    <span class="hljs-attribute">allow</span> all;<br>   <span class="hljs-comment"># deny all;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>使用 docker 部署<code>nginx-prometheus-exporter</code>：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">nginx-prometheus-exporter:</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">nginx/nginx-prometheus-exporter</span><br>  <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx-prometheus-exporter</span><br>  <span class="hljs-attr">hostname:</span> <span class="hljs-string">nginx-prometheus-exporter</span><br>  <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9113:9113&quot;</span><br>  <span class="hljs-attr">command:</span> <span class="hljs-string">-nginx.scrape-uri</span> <span class="hljs-string">http://172.17.0.1:8080/nginx_status</span> <span class="hljs-comment"># 指向 nginx 的该地址</span><br></code></pre></div></td></tr></table></figure>

<p>然后在 prom 的配置文件中添加相应 job：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;nginx-prometheus-exporter&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;nginx-prometheus-exporter 的 IP:PORT&#x27;</span>]<br></code></pre></div></td></tr></table></figure>

<h2 id="prometheus-nginxlog-exporter"><a href="#prometheus-nginxlog-exporter" class="headerlink" title="prometheus-nginxlog-exporter"></a>prometheus-nginxlog-exporter</h2><p>log-exporter 也可以使用 docker 部署，只要把 nginx 的日志 mount 给容器即可：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">nginxlog-exporter:</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/martinhelmich/prometheus-nginxlog-exporter</span><br>  <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginxlog-exporter</span><br>  <span class="hljs-attr">hostname:</span> <span class="hljs-string">nginxlog-exporter</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;4040:4040&quot;</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">./exporter.hcl:/etc/exporter.hcl</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">/var/log/nginx:/var/lib/nginx:ro</span><br>  <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;-config-file&quot;</span>, <span class="hljs-string">&quot;/etc/exporter.hcl&quot;</span>]<br></code></pre></div></td></tr></table></figure>

<p>配置文件 <code>exporter.hcl</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs hcl">listen &#123;<br>  port = 4040<br>  address = &quot;0.0.0.0&quot;<br>  metrics_endpoint = &quot;/metrics&quot;<br>&#125;<br><br>namespace &quot;nginx&quot; &#123;<br>  format = &quot;$remote_addr - $remote_user [$time_local] \&quot;$request\&quot; $status $body_bytes_sent \&quot;$http_referer\&quot; \&quot;$http_user_agent\&quot; rt=$request_time uct=\&quot;$upstream_connect_time\&quot; uht=\&quot;$upstream_header_time\&quot; urt=\&quot;$upstream_response_time\&quot;&quot;<br>  source &#123;<br>    files = [<br>      &quot;/var/lib/nginx/access_prod.log&quot;<br>    ]<br>  &#125;<br><br>  # log can be printed to std out, e.g. for debugging purposes (disabled by default)<br>  print_log = true<br><br>  # metrics_override = &#123; prefix = &quot;myprefix&quot; &#125;<br>  # namespace_label = &quot;vhost&quot;<br><br>  labels &#123;<br>    app = &quot;nginx&quot;<br>    environment = &quot;prod&quot;<br>  &#125;<br><br>  histogram_buckets = [.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10]<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><strong>以及需要配置 nginx 的日志格式和 log exporter 匹配</strong>：</p>
<figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;<br>  <span class="hljs-attribute">log_format</span> upstream_time <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] &#x27;</span><br>                  <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$request</span>&quot; <span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> &#x27;</span><br>                  <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$http_referer</span>&quot; &quot;<span class="hljs-variable">$http_user_agent</span>&quot; &#x27;</span><br>                  <span class="hljs-string">&#x27;rt=<span class="hljs-variable">$request_time</span> uct=&quot;<span class="hljs-variable">$upstream_connect_time</span>&quot; uht=&quot;<span class="hljs-variable">$upstream_header_time</span>&quot; urt=&quot;<span class="hljs-variable">$upstream_response_time</span>&quot;&#x27;</span>;<br><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>执行 <code>curl localhost:4040/metrics</code>即可。</p>
<p>配置 prom 的 job：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;prometheus-nginxlog-exporter&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;prometheus-nginxlog-exporter 的 IP:PORT&#x27;</span>]<br></code></pre></div></td></tr></table></figure>

<h1 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox-exporter"></a>blackbox-exporter</h1><p>参考 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/guides/multi-target-exporter/">https://prometheus.io/docs/guides/multi-target-exporter/</a>，<a target="_blank" rel="noopener" href="https://github.com/prometheus/blackbox_exporter">https://github.com/prometheus/blackbox_exporter</a>。</p>
<blockquote>
<p>The blackbox exporter allows blackbox probing of endpoints over HTTP, HTTPS, DNS, TCP, ICMP and gRPC.</p>
</blockquote>
<p>blackbox exporter 可用来验证 HTTP 端口是否存活。blackbox exportter 生成自己使用所谓的 multi-target 模式，归根结底就是说<strong>该 exporter 只负责发请求，向谁发，何时发，全由 prom 去给定，在 prom 对该 exporter 的请求中给定在请求参数中，该 exporter 自己没有关于业务的任何配置</strong>。请求类似：<code>http://localhost:9115/probe?target=prometheus.io&amp;module=http_2xx</code>。</p>
<p><strong>注意 blackbox 默认走的 IPV6</strong>，把它配置文件弄下来，检查<code>modules.http_2xx.http.preferred_ip_protocol</code> 是否为 ip4。</p>
<figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">curl -o blackbox.yml https://raw.githubusercontent.com/prometheus/blackbox_exporter/master/blackbox.yml<br></code></pre></div></td></tr></table></figure>

<p>使用 docker 部署：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">blackbox-exporter:</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">prom/blackbox-exporter</span><br>  <span class="hljs-attr">container_name:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">hostname:</span> <span class="hljs-string">blackbox-exporter</span><br>  <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9115:9115&quot;</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">./blackbox.yml:/blackbox.yml:ro</span><br>  <span class="hljs-attr">command:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/blackbox.yml</span><br></code></pre></div></td></tr></table></figure>

<p>prom 配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;blackbox-exporter&#x27;</span><br>  <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;172.17.0.1:9115&#x27;</span>]<br></code></pre></div></td></tr></table></figure>

<p>注意该配置中不包含真正要监测的端点。要配置真正检测的端点，<strong>需要另行配置 job 去以特定查询参数去调 blackbox 去让它发请求：</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><br><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">repo_alive</span> <br>  <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/probe</span><br>  <span class="hljs-attr">params:</span><br>    <span class="hljs-attr">module:</span> [<span class="hljs-string">http_2xx</span>]<br>    <span class="hljs-attr">target:</span> [<span class="hljs-string">https://github.com/prometheus/blackbox_exporter</span>]<br>  <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;172.17.0.1:9115&#x27;</span>]<br><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">github_alive</span> <br>  <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/probe</span><br>  <span class="hljs-attr">params:</span><br>    <span class="hljs-attr">module:</span> [<span class="hljs-string">http_2xx</span>]<br>    <span class="hljs-attr">target:</span> [<span class="hljs-string">https://github.com</span>]<br>  <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;172.17.0.1:9115&#x27;</span>]<br></code></pre></div></td></tr></table></figure>

<p>但一个接口定义一个 job 有点麻烦，可以使用 prom 的 relabel 机制：</p>
<p>简单理解该 relabel 的话就是 <code>target_label = source_label | replacement</code>。如果要重命名 instance 的话是否必须得用 relabel？</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">blackbox-http</span> <span class="hljs-comment"># To get metrics about the exporter’s targets</span><br>  <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/probe</span><br>  <span class="hljs-attr">params:</span><br>    <span class="hljs-attr">module:</span> [<span class="hljs-string">http_2xx</span>]<br>  <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">http://prometheus.io</span>    <span class="hljs-comment"># Target to probe with http</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">https://prometheus.io</span>   <span class="hljs-comment"># Target to probe with https</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">http://example.com:8080</span> <span class="hljs-comment"># Target to probe with http on port 8080</span><br>  <span class="hljs-attr">relabel_configs:</span><br>    <span class="hljs-comment"># 原始 url 为：http://prometheus.io/probe?module=http_200</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__address__</span>] <span class="hljs-comment"># 映射 address 到 param.target</span><br>      <span class="hljs-attr">target_label:</span> <span class="hljs-string">__param_target</span> <br>    <span class="hljs-comment"># 此时为：http://prometheus.io/probe?target=http://prometheus.io&amp;module=http_2xx</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__param_target</span>] <br>      <span class="hljs-attr">target_label:</span> <span class="hljs-string">instance</span> <span class="hljs-comment"># 不影响 url，但会给响应标识 label（这就是 promQL 里的 instance 字段，默认值和 address 相同）</span><br>    <span class="hljs-comment"># 没有这一步的话，instance 全部都会是 __address__</span><br>      <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">target_label:</span> <span class="hljs-string">__address__</span> <span class="hljs-comment"># 把地址替换为 localhost:9115  </span><br>      <span class="hljs-attr">replacement:</span> <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9115</span>  <br>    <span class="hljs-comment"># 此时为 172.17.0.1:9115/probe?target=http://prometheus.io&amp;module=http_2xx</span><br></code></pre></div></td></tr></table></figure>

<p>该项目接口响应码总为 200，实际响应码在 body 的 code 字段中，可以使用正则去检查请求是否正常。这个配置需要写在 blackbox 的配置文件中，新增一个 module，并配置 prom 去使用该 module 即可，参考<a target="_blank" rel="noopener" href="https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md">https://github.com/prometheus/blackbox_exporter/blob/master/CONFIGURATION.md</a>：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">modules:</span><br>  <span class="hljs-comment"># 新增一个 module 检查 body 是否包含&quot;code&quot;:2xx</span><br>  <span class="hljs-attr">http_body_2xx:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">fail_if_body_not_matches_regexp:</span> <br>        <span class="hljs-bullet">-</span> <span class="hljs-string">\&quot;code\&quot;\b*?:\b*?2\d\d</span><br>      <span class="hljs-attr">preferred_ip_protocol:</span> <span class="hljs-string">&quot;ip4&quot;</span><br>  <span class="hljs-attr">http_2xx:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">preferred_ip_protocol:</span> <span class="hljs-string">&quot;ip4&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>另一个更激进的利用 relabel 的配置如下，它利用正则去给每个实例取名字。</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">blackbox-ping</span><br>  <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/probe</span><br>  <span class="hljs-attr">params:</span><br>    <span class="hljs-attr">module:</span> [<span class="hljs-string">icmp</span>]<br>  <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>      <span class="hljs-comment"># 名称$$URL</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ping_15$$172.31.129.15</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ping_251$$172.31.129.251</span><br>  <span class="hljs-attr">relabel_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__address__</span>] <span class="hljs-comment"># target = __address__[1] # 这里做了正则</span><br>      <span class="hljs-attr">regex:</span> <span class="hljs-string">.*?\$\$(.*)</span><br>      <span class="hljs-attr">target_label:</span> <span class="hljs-string">__param_target</span> <br>      <span class="hljs-attr">replacement:</span> <span class="hljs-string">$&#123;1&#125;</span>   <br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__address__</span>] <span class="hljs-comment"># instance = __address__[1]</span><br>      <span class="hljs-attr">regex:</span> <span class="hljs-string">(.*?)\$\$.*</span><br>      <span class="hljs-attr">target_label:</span> <span class="hljs-string">instance</span> <br>      <span class="hljs-attr">replacement:</span> <span class="hljs-string">$&#123;1&#125;</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">target_label:</span> <span class="hljs-string">__address__</span> <span class="hljs-comment"># 把地址替换为 localhost:9115  </span><br>      <span class="hljs-attr">replacement:</span> <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9115</span> <br></code></pre></div></td></tr></table></figure>

<h2 id="处理-DNS-问题"><a href="#处理-DNS-问题" class="headerlink" title="处理 DNS 问题"></a>处理 DNS 问题</h2><p>blackbox exporter 默认会把域名转换成 IP 后再发送请求，这在服务器需要域名信息时会导致问题，要避免该情况，必须使用一个代理服务器，配置 blackbox exporter 容器使用该代理，并在 module 中配置 <code>skip_resolve_phase_with_proxy</code> 为 true，这里假设宿主机有一个 HTTP 代理，监听 8888 端口：</p>
<figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">modules:</span><br>  <span class="hljs-comment"># blackbox.yml 中新增 module：</span><br>  <span class="hljs-attr">nodns_body_2xx:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">preferred_ip_protocol:</span> <span class="hljs-string">&quot;ip4&quot;</span><br>      <span class="hljs-attr">fail_if_body_not_matches_regexp:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">\&quot;code\&quot;\b*?:\b*?2\d\d</span><br>      <span class="hljs-comment"># 172.17.0.1 总为宿主机</span><br>      <span class="hljs-attr">proxy_url:</span> <span class="hljs-string">http://172.17.0.1:8888</span><br>      <span class="hljs-attr">skip_resolve_phase_with_proxy:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># 下面的配置不知是否必要</span><br>      <span class="hljs-comment"># headers:</span><br>      <span class="hljs-comment">#   Host: www.hbkcgyl.com</span><br>      <span class="hljs-comment"># tls_config:</span><br>      <span class="hljs-comment">#   server_name: www.hbkcgyl.com</span><br></code></pre></div></td></tr></table></figure>

<p>创建代理服务器可以使用 tinyproxy：</p>
<figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">yum install tinyproxy<br></code></pre></div></td></tr></table></figure>

<p>然后编辑<code>/etc/tinyproxy/tinyproxy.conf</code>，注释掉<code>Allow 127.0.0.1</code>使得允许所有连接，然后启动 tinyproxy：</p>
<figure class="highlight sh"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sh">systemctl <span class="hljs-built_in">enable</span> tinyproxy<br>systemctl start tinyproxy<br></code></pre></div></td></tr></table></figure>

<h1 id="mysql-exporter-redis-exporter"><a href="#mysql-exporter-redis-exporter" class="headerlink" title="mysql exporter, redis exporter"></a>mysql exporter, redis exporter</h1><p>TODO</p>
<h1 id="所有配置"><a href="#所有配置" class="headerlink" title="所有配置"></a>所有配置</h1><h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">nginx-prometheus-exporter:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx/nginx-prometheus-exporter</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx-prometheus-exporter</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">nginx-prometheus-exporter</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9113:9113&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">-nginx.scrape-uri</span> <span class="hljs-string">http://172.17.0.1:10800/nginx_status</span> <span class="hljs-comment"># 指向 nginx 的该地址</span><br><br>  <span class="hljs-attr">nginxlog-exporter:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/martinhelmich/prometheus-nginxlog-exporter</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginxlog-exporter</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">nginxlog-exporter</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;4040:4040&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./exporter.hcl:/etc/exporter.hcl</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/var/log/nginx:/var/lib/nginx:ro</span><br>    <span class="hljs-attr">command:</span> [<span class="hljs-string">&quot;-config-file&quot;</span>, <span class="hljs-string">&quot;/etc/exporter.hcl&quot;</span>]<br><br>  <span class="hljs-attr">prometheus:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">prometheus</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./prometheus.yml:/etc/prometheus/prometheus.yml:ro</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./rules:/etc/prometheus/rules:ro</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9090:9090&quot;</span><br><br>  <span class="hljs-attr">grafana:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">grafana</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">grafana</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3000:3000&quot;</span><br><br>  <span class="hljs-attr">alertmanager:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/alertmanager</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">alertmanager</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">alertmanager</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9093:9093&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./alertmanager:/config&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">--config.file=/config/alertmanager.yml</span> <span class="hljs-string">--log.level=info</span><br><br><br>  <span class="hljs-attr">blackbox-exporter:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/blackbox-exporter</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">blackbox-exporter</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">blackbox-exporter</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;9115:9115&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">./blackbox.yml:/blackbox.yml:ro</span><br>    <span class="hljs-attr">command:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">--config.file=/blackbox.yml</span><br></code></pre></div></td></tr></table></figure>

<h2 id="prometheus-yml"><a href="#prometheus-yml" class="headerlink" title="prometheus.yml"></a>prometheus.yml</h2><figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">global:</span><br>  <span class="hljs-attr">scrape_interval:</span>     <span class="hljs-string">15s</span><br>  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-comment"># 监控 prometheus 自己</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;prometheus&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;172.17.0.1:9090&#x27;</span>] <span class="hljs-comment"># 172.17.0.1 总是宿主机</span><br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;nginx-prometheus-exporter&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;nginx-prometheus-exporter:9113&#x27;</span>]<br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">nginxlog-exporter</span><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">nginxlog-exporter:4040</span><br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">node162</span><br>    <span class="hljs-attr">static_configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9101</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">&#x27;blackbox-exporter&#x27;</span><br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">&#x27;blackbox-exporter:9115&#x27;</span>]<br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">blackbox-http</span><br>    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/probe</span><br>    <span class="hljs-attr">params:</span><br>      <span class="hljs-attr">module:</span> [<span class="hljs-string">http_2xx</span>]<br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>        <span class="hljs-comment"># 名称$$URL</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">baidu$$https://baidu.com</span><br>    <span class="hljs-attr">relabel_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__address__</span>] <span class="hljs-comment"># target = __address__[1] # 这里做了正则</span><br>        <span class="hljs-attr">regex:</span> <span class="hljs-string">.*?\$\$(.*)</span><br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">__param_target</span><br>        <span class="hljs-attr">replacement:</span> <span class="hljs-string">$&#123;1&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__address__</span>] <span class="hljs-comment"># instance = __address__[1]</span><br>        <span class="hljs-attr">regex:</span> <span class="hljs-string">(.*?)\$\$.*</span><br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">instance</span><br>        <span class="hljs-attr">replacement:</span> <span class="hljs-string">$&#123;1&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">target_label:</span> <span class="hljs-string">__address__</span> <span class="hljs-comment"># 把地址替换为 localhost:9115</span><br>        <span class="hljs-attr">replacement:</span> <span class="hljs-string">blackbox-exporter:9115</span><br><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">blackbox-ping</span><br>    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">/probe</span><br>    <span class="hljs-attr">params:</span><br>      <span class="hljs-attr">module:</span> [<span class="hljs-string">icmp</span>]<br>    <span class="hljs-attr">static_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span><br>        <span class="hljs-comment"># 名称$$URL</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ping_self$$172.17.0.1</span><br>    <span class="hljs-attr">relabel_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__address__</span>] <span class="hljs-comment"># target = __address__[1] # 这里做了正则</span><br>        <span class="hljs-attr">regex:</span> <span class="hljs-string">.*?\$\$(.*)</span><br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">__param_target</span><br>        <span class="hljs-attr">replacement:</span> <span class="hljs-string">$&#123;1&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__address__</span>] <span class="hljs-comment"># instance = __address__[1]</span><br>        <span class="hljs-attr">regex:</span> <span class="hljs-string">(.*?)\$\$.*</span><br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">instance</span><br>        <span class="hljs-attr">replacement:</span> <span class="hljs-string">$&#123;1&#125;</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">target_label:</span> <span class="hljs-string">__address__</span> <span class="hljs-comment"># 把地址替换为 localhost:9115</span><br>        <span class="hljs-attr">replacement:</span> <span class="hljs-string">blackbox-exporter:9115</span><br><br><span class="hljs-comment"># 告警规则文件</span><br><span class="hljs-attr">rule_files:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/etc/prometheus/rules/*.yml&quot;</span><br><br><span class="hljs-comment"># 告警处理者，即 alertmanager</span><br><span class="hljs-attr">alerting:</span><br>  <span class="hljs-attr">alertmanagers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">scheme:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">static_configs:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [ <span class="hljs-string">&#x27;alertmanager:9093&#x27;</span> ]<br></code></pre></div></td></tr></table></figure>

<h2 id="blackbox-yml"><a href="#blackbox-yml" class="headerlink" title="blackbox.yml"></a>blackbox.yml</h2><figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">modules:</span><br>  <span class="hljs-attr">http_2xx:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">preferred_ip_protocol:</span> <span class="hljs-string">&quot;ip4&quot;</span><br>  <span class="hljs-attr">http_post_2xx:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">method:</span> <span class="hljs-string">POST</span><br>  <span class="hljs-attr">tcp_connect:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">tcp</span><br>  <span class="hljs-attr">pop3s_banner:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">tcp</span><br>    <span class="hljs-attr">tcp:</span><br>      <span class="hljs-attr">query_response:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">expect:</span> <span class="hljs-string">&quot;^+OK&quot;</span><br>      <span class="hljs-attr">tls:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">tls_config:</span><br>        <span class="hljs-attr">insecure_skip_verify:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">grpc:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-attr">grpc:</span><br>      <span class="hljs-attr">tls:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">preferred_ip_protocol:</span> <span class="hljs-string">&quot;ip4&quot;</span><br>  <span class="hljs-attr">grpc_plain:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">grpc</span><br>    <span class="hljs-attr">grpc:</span><br>      <span class="hljs-attr">tls:</span> <span class="hljs-literal">false</span><br>      <span class="hljs-attr">service:</span> <span class="hljs-string">&quot;service1&quot;</span><br>  <span class="hljs-attr">ssh_banner:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">tcp</span><br>    <span class="hljs-attr">tcp:</span><br>      <span class="hljs-attr">query_response:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">expect:</span> <span class="hljs-string">&quot;^SSH-2.0-&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">send:</span> <span class="hljs-string">&quot;SSH-2.0-blackbox-ssh-check&quot;</span><br>  <span class="hljs-attr">irc_banner:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">tcp</span><br>    <span class="hljs-attr">tcp:</span><br>      <span class="hljs-attr">query_response:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">send:</span> <span class="hljs-string">&quot;NICK prober&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">send:</span> <span class="hljs-string">&quot;USER prober prober prober :prober&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">expect:</span> <span class="hljs-string">&quot;PING :([^ ]+)&quot;</span><br>        <span class="hljs-attr">send:</span> <span class="hljs-string">&quot;PONG $&#123;1&#125;&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">expect:</span> <span class="hljs-string">&quot;^:[^ ]+ 001&quot;</span><br>  <span class="hljs-attr">icmp:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">icmp</span><br>  <span class="hljs-attr">icmp_ttl5:</span><br>    <span class="hljs-attr">prober:</span> <span class="hljs-string">icmp</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span><br>    <span class="hljs-attr">icmp:</span><br>      <span class="hljs-attr">ttl:</span> <span class="hljs-number">5</span><br></code></pre></div></td></tr></table></figure>

<h2 id="alertmanager-x2F-alertmanager-yml"><a href="#alertmanager-x2F-alertmanager-yml" class="headerlink" title="alertmanager&#x2F;alertmanager.yml"></a>alertmanager&#x2F;alertmanager.yml</h2><figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-comment"># 根路由，必须匹配所有告警</span><br><span class="hljs-attr">route:</span><br>  <span class="hljs-attr">receiver:</span> <span class="hljs-string">&#x27;dingtalk&#x27;</span><br>  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">1h</span> <span class="hljs-comment"># 告警间隔 1h 才会发一次，resolved 消息不受此限制</span><br>  <span class="hljs-attr">group_by:</span> [ <span class="hljs-string">serverity</span>, <span class="hljs-string">alertname</span> ]<br><br><span class="hljs-attr">receivers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;dingtalk&#x27;</span><br>    <span class="hljs-attr">webhook_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">&#x27;钉钉 hook&#x27;</span><br>        <span class="hljs-attr">send_resolved:</span> <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure>

<h2 id="rules-x2F-rule-yml"><a href="#rules-x2F-rule-yml" class="headerlink" title="rules&#x2F;rule.yml"></a>rules&#x2F;rule.yml</h2><figure class="highlight yml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yml"><span class="hljs-attr">groups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">实例存活告警规则</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">实例存活告警</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">up</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">for:</span> <span class="hljs-string">30s</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">serverity:</span> <span class="hljs-string">Disaster</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;节点失联&quot;</span><br>          <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;节点断联已超过 1 分钟&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">内存告警规则</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">&quot;内存使用率告警&quot;</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">round((node_memory_MemTotal_bytes</span> <span class="hljs-bullet">-</span> <span class="hljs-string">(node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes</span> <span class="hljs-string">))</span> <span class="hljs-string">/</span> <span class="hljs-string">node_memory_MemTotal_bytes</span> <span class="hljs-string">*</span> <span class="hljs-number">100</span><span class="hljs-string">,1)</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">75</span>    <span class="hljs-comment"># 告警阈值为当内存使用率大于 75%</span><br>        <span class="hljs-attr">for:</span> <span class="hljs-string">30s</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;服务器内存报警&quot;</span><br>          <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;内存资源利用率大于 75%！（当前值：<span class="hljs-template-variable">&#123;&#123; $value &#125;&#125;</span>%)&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">端点断连告警规则</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">端点断连告警</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">probe_success</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">serverity:</span> <span class="hljs-string">Disaster</span><br>        <span class="hljs-attr">for:</span> <span class="hljs-string">30s</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;端点断连告警&quot;</span><br>          <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;端点断连已超过 1 分钟&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">磁盘告警规则</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">磁盘空间不足</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">round(100</span> <span class="hljs-string">*</span> <span class="hljs-string">(node_filesystem_size_bytes</span> <span class="hljs-bullet">-</span> <span class="hljs-string">node_filesystem_avail_bytes)</span> <span class="hljs-string">/</span> <span class="hljs-string">node_filesystem_size_bytes,</span> <span class="hljs-number">1</span><span class="hljs-string">)</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">75</span><br>        <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;磁盘使用空间过高&quot;</span><br>          <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;磁盘使用空间超过了 75%&quot;</span><br></code></pre></div></td></tr></table></figure>


<h2 id="exporter-hcl"><a href="#exporter-hcl" class="headerlink" title="exporter.hcl"></a>exporter.hcl</h2><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs hcl">listen &#123;<br>  port = 4040<br>  address = &quot;0.0.0.0&quot;<br>  metrics_endpoint = &quot;/metrics&quot;<br>&#125;<br><br>namespace &quot;nginx&quot; &#123;<br>  format = &quot;$remote_addr - $remote_user [$time_local] \&quot;$request\&quot; $status $body_bytes_sent \&quot;$http_referer\&quot; \&quot;$http_user_agent\&quot; rt=$request_time uct=\&quot;$upstream_connect_time\&quot; uht=\&quot;$upstream_header_time\&quot; urt=\&quot;$upstream_response_time\&quot;&quot;<br>  source &#123;<br>    files = [<br>      &quot;/var/lib/nginx/access_prod.log&quot;<br>    ]<br>  &#125;<br><br>  # log can be printed to std out, e.g. for debugging purposes (disabled by default)<br>  print_log = true<br><br>  # metrics_override = &#123; prefix = &quot;myprefix&quot; &#125;<br>  # namespace_label = &quot;vhost&quot;<br><br>  labels &#123;<br>    app = &quot;nginx&quot;<br>    environment = &quot;prod&quot;<br>  &#125;<br><br>  histogram_buckets = [.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10]<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="x2F-etc-x2F-nginx-x2F-nginx-conf"><a href="#x2F-etc-x2F-nginx-x2F-nginx-conf" class="headerlink" title="&#x2F;etc&#x2F;nginx&#x2F;nginx.conf"></a>&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</h2><figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-attribute">user</span> www-data;<br><span class="hljs-attribute">worker_processes</span> auto;<br><span class="hljs-attribute">pid</span> /run/nginx.pid;<br><span class="hljs-attribute">include</span> /etc/nginx/modules-enabled/<span class="hljs-regexp">*.conf</span>;<br><br><span class="hljs-section">events</span> &#123;<br>        <span class="hljs-attribute">worker_connections</span> <span class="hljs-number">768</span>;<br>        <span class="hljs-comment"># multi_accept on;</span><br>&#125;<br><br><span class="hljs-section">http</span> &#123;<br><br>        <span class="hljs-comment">##</span><br>        <span class="hljs-comment"># Basic Settings</span><br>        <span class="hljs-comment">##</span><br><br>        <span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">tcp_nopush</span> <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">types_hash_max_size</span> <span class="hljs-number">2048</span>;<br>        <span class="hljs-comment"># server_tokens off;</span><br><br>        <span class="hljs-comment"># server_names_hash_bucket_size 64;</span><br>        <span class="hljs-comment"># server_name_in_redirect off;</span><br><br>        <span class="hljs-attribute">include</span> /etc/nginx/mime.types;<br>        <span class="hljs-attribute">default_type</span> application/octet-stream;<br><br>        <span class="hljs-comment">##</span><br>        <span class="hljs-comment"># SSL Settings</span><br>        <span class="hljs-comment">##</span><br><br>        <span class="hljs-attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>; <span class="hljs-comment"># Dropping SSLv3, ref: POODLE</span><br>        <span class="hljs-attribute">ssl_prefer_server_ciphers</span> <span class="hljs-literal">on</span>;<br><br>        <span class="hljs-comment">##</span><br>        <span class="hljs-comment"># Logging Settings</span><br>        <span class="hljs-comment">##</span><br><span class="hljs-attribute">log_format</span> upstream_time <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] &#x27;</span><br>                         <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$request</span>&quot; <span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> &#x27;</span><br>                         <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$http_referer</span>&quot; &quot;<span class="hljs-variable">$http_user_agent</span>&quot; &#x27;</span><br>                         <span class="hljs-string">&#x27;rt=<span class="hljs-variable">$request_time</span> uct=&quot;<span class="hljs-variable">$upstream_connect_time</span>&quot; uht=&quot;<span class="hljs-variable">$upstream_header_time</span>&quot; urt=&quot;<span class="hljs-variable">$upstream_response_time</span>&quot;&#x27;</span>;<br>        <span class="hljs-attribute">access_log</span> /var/log/nginx/access.log;<br>        <span class="hljs-attribute">error_log</span> /var/log/nginx/<span class="hljs-literal">error</span>.log;<br><br>        <span class="hljs-comment">##</span><br>        <span class="hljs-comment"># Gzip Settings</span><br>        <span class="hljs-comment">##</span><br><br>        <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br><br>        <span class="hljs-comment"># gzip_vary on;</span><br>        <span class="hljs-comment"># gzip_proxied any;</span><br>        <span class="hljs-comment"># gzip_comp_level 6;</span><br>        <span class="hljs-comment"># gzip_buffers 16 8k;</span><br>        <span class="hljs-comment"># gzip_http_version 1.1;</span><br>        <span class="hljs-comment"># gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><br>        <span class="hljs-comment">##</span><br>        <span class="hljs-comment"># Virtual Host Configs</span><br>        <span class="hljs-comment">##</span><br><br>        <span class="hljs-attribute">include</span> /etc/nginx/conf.d/<span class="hljs-regexp">*.conf</span>;<br>        <span class="hljs-attribute">include</span> /etc/nginx/sites-enabled/*;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="PromQL"><a href="#PromQL" class="headerlink" title="PromQL"></a>PromQL</h1><p>参考 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/basics/">https://prometheus.io/docs/prometheus/latest/querying/basics/</a>。</p>
<p>PromQL 让用户能够实时地查询和聚合时间序列数据。PromQL 虽然第一眼看起来有点像 numpy，但其实它是更像 SQL 的，只不过没有显式的 select 和 where。</p>
<p>PromQL 的表达式可求值为四种类型：</p>
<ul>
<li>Instant Vector：瞬时向量，一个时间序列的集合，其中每个时间序列只有一个样本，他们的时间戳相同</li>
<li>Range Vector：范围向量：一个时间序列的集合，每个时间序列都包含一个时间范围的数据点</li>
<li>Scalar：标量，一个浮点数</li>
<li>String：字符串，无实用意义</li>
</ul>
<p>注意 PromQL 总是用 UTC 时区而非本机时区去操作的。</p>
<h2 id="Instant-vector-selector"><a href="#Instant-vector-selector" class="headerlink" title="Instant vector selector"></a>Instant vector selector</h2><p><img src="/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-1.png" alt="瞬时向量"></p>
<p>瞬时向量就像对每个时间序列都取同一个时间点的数据，下面的 PromQL 均取得的是瞬时向量：</p>
<figure class="highlight ruby"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ruby">up     <span class="hljs-comment"># 查询所有的有 up 名称的时间序列 中当前时间戳的值</span><br>up&#123;job=<span class="hljs-string">&quot;a&quot;</span>&#125;   <span class="hljs-comment"># 筛选 job 为 a 的有 up 名称的时间序列 中当前时间戳的值</span><br>up&#123;job=~<span class="hljs-string">&quot;db_.*&quot;</span>, job!=<span class="hljs-string">&quot;db_01_exporter&quot;</span>&#125; <span class="hljs-comment"># job 满足正则 ^db_.*$ 且不为 db_01_exporter</span><br>&#123;__name__=<span class="hljs-string">&quot;up&quot;</span>&#125; <span class="hljs-comment"># 等价于 up</span><br></code></pre></div></td></tr></table></figure>

<p><code>up&#123;...&#125;</code>称为<code>vector selector</code>，<strong>它筛选的是时间序列</strong>、仅有<code>&#123;&#125;</code>时，得到的时瞬时向量，所以这里叫他瞬时向量选择器。</p>
<h2 id="Range-vector-selector"><a href="#Range-vector-selector" class="headerlink" title="Range vector selector"></a>Range vector selector</h2><p><img src="/2024/06-28Prometheus%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-2.png" alt="范围向量"></p>
<p>范围向量就像对每个时间序列取一定时间范围内点的数据，下面的 PromQL 均取得的是范围向量：</p>
<figure class="highlight ruby"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ruby">up&#123;job=~<span class="hljs-string">&quot;db_.*&quot;</span>&#125;[1m] <span class="hljs-comment"># 筛选 job 满足 ^db_.*$ 的有 up 名称的时间序列中过去 1 分钟的所有值</span><br>up[30<span class="hljs-symbol">m:</span>5m] <span class="hljs-comment"># 筛选过去 30 分钟的值，其中每个时间序列每 5 分钟取样一次</span><br></code></pre></div></td></tr></table></figure>

<p><strong>范围向量不能显示为 graph</strong>，也就是说在 grafana 和 prom 的 web 界面中，显示图表时不能使用范围向量类型的表达式。</p>
<p><strong>graph 只接受瞬时向量</strong>，其将对于查询区间中的每一个时间点（如过去一小时的每一分钟）去执行该瞬时向量表达式，比如<code>rate(http_requests_total[5m])</code>，假设现在是 11 点，时间区间是过去一小时，则其会在 10:00，10:01，10:02 等时间点执行查询，获取这些时间点最近 5 分钟的请求速率，并以此绘制图表，</p>
<h2 id="offset"><a href="#offset" class="headerlink" title="offset"></a>offset</h2><p>offset 修饰符能够修饰瞬时向量和范围向量，表示对当前时间戳进行一定偏移来进行查询：</p>
<figure class="highlight ruby"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ruby">up offset 10m <span class="hljs-comment"># 查询 10m 前的值</span><br>up[5m] offset 10m <span class="hljs-comment"># 查询 15m 到 10m 前的值</span><br></code></pre></div></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title="@"></a>@</h2><p>@ 修饰符能够修饰瞬时向量和范围向量，表示指定当前时间戳来进行查询，@接受一个 unix 时间戳，即一个从 1970 年 1 月 1 日至今的毫数：</p>
<figure class="highlight ruby"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ruby">up @ <span class="hljs-number">1719370800</span> <span class="hljs-comment"># 查询 2024-06-26 11:00:00+08:00 </span><br>up[5m] @ <span class="hljs-number">1719370800</span> <span class="hljs-comment"># 查询 10:55 到 11:00 之间的数据 </span><br>up @ <span class="hljs-number">1719370800</span> offset 5m <span class="hljs-comment"># 查询 10:55 的数据</span><br></code></pre></div></td></tr></table></figure>

<p>offset 和@位置可交换，offset 总是以@中的时间戳为基准做偏移。</p>
<h2 id="算术操作符"><a href="#算术操作符" class="headerlink" title="算术操作符"></a>算术操作符</h2><p>算术操作符包括 <code>+-*/%^</code>，其中<code>^</code>是 pow。</p>
<p>算术操作符的两操作数可以为标量-标量，瞬时矢量-标量或瞬时矢量-瞬时矢量。操作数为两个矢量时，逐元素去操作（称为 vector matching），得到一个矢量，操作数为一个矢量一个标量时，把标量扩张成矢量去操作，得到一个矢量。结果矢量会抹掉指标名。</p>
<h2 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h2><p>比较操作符同 C 语言。<strong>PromQL 的比较运算符，默认做的是筛选操作，就像 numpy 一样</strong>。比如<code>up == 0</code>是筛选值为 0 的时间序列。要不做筛选而是逐维度去做比较，在操作符后加上 <code>bool</code>修饰符，如 <code>up == bool 0</code>，这样会得到所有的名称为 up 的时间序列，其中值原本为 1 的值为 0，原本为 0 的为 1。<strong>PromQL 认为 0 是 false，1 是 true</strong>。</p>
<p>比较运算符同样支持标量-标量，瞬时矢量-标量或瞬时矢量-瞬时矢量。操作数为两个标量时，修饰符<code>bool</code>必须给定，操作数为两个矢量时，逐维度作比较，<strong>筛选比较成功的左操作数</strong>，比如<code>(up + 1) &gt; up</code>，返回值为 1 和 2。</p>
<p>如果修饰符<code>bool</code>被给定，丢弃指标名。</p>
<h2 id="集合操作符"><a href="#集合操作符" class="headerlink" title="集合操作符"></a>集合操作符</h2><p>集合操作符不改变数据的值，而是以指标名、所有标签为标识符做集合操作。集合操作符包括 <code>and</code>，<code>or</code>，<code>unless</code>，分别为交集，并集，差集。</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>PromQL 可以认为是强类型的，它的函数接受参数和返回值的类型均被明确规定。函数定义可以参照 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/functions/">https://prometheus.io/docs/prometheus/latest/querying/functions/</a>。</p>
<p><strong>所有函数都返回瞬时向量</strong>。要得到范围向量需要利用子查询。</p>
<p>Prom 允许嵌套的查询，如<code>rate(node_disk_written_bytes_total[5m])</code>，在这里<code>node_disk_written_bytes_total[5m]</code>是子查询。</p>
<p>子查询如果没有给定范围，则其返回的必定是瞬时向量，需要给定范围才能得到范围向量。</p>
<figure class="highlight ruby"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ruby">node_disk_written_bytes_total[5m] <span class="hljs-comment"># 最近 5 分钟的写盘字节数，范围向量</span><br>rate(node_disk_written_bytes_total[5m]) <span class="hljs-comment"># 最近 5 分钟写盘速率，瞬时向量</span><br>rate(node_disk_written_bytes_total[5m])[30<span class="hljs-symbol">m:</span>5m] <span class="hljs-comment"># 最近 30 分钟中，每隔 5 分钟的最近 5 分钟的写盘速率，范围向量</span><br>avg_over_time(rate(node_disk_written_bytes_total[5m])[30<span class="hljs-symbol">m:</span>5m]) <span class="hljs-comment"># 最近 30 分钟中，每隔 5 分钟的最近 5 分钟的写盘速率的平均值，瞬时向量</span><br>avg_over_time(rate(node_disk_written_bytes_total[5m])[30<span class="hljs-symbol">m:</span>5m])[10<span class="hljs-symbol">h:</span>1h] <span class="hljs-comment"># 最近 10 小时中，每隔 1 小时的时间点下 “最近 30 分钟中，每隔 5 分钟的最近 5 分钟的写盘速率的平均值”，范围向量</span><br></code></pre></div></td></tr></table></figure>

<p>是否可以说，函数调用的语法其实是<code>&lt;函数名&gt;(&lt;函数参数&gt;)[ [&lt;范围&gt;:&lt;步长&gt;] ]</code>？</p>
<h2 id="时间范围"><a href="#时间范围" class="headerlink" title="时间范围"></a>时间范围</h2><p>Prometheus 的时间范围有点迷惑，如<code>[24h:6h]</code>，一般就会想到，比如现在是 UTC 时间 13 点，它会取到 13 点，7 点，1 点，昨天 19 点，但它行为似乎不是这样——它实际上会做一个“对齐”，取 12 点，6 点，0 点和昨天 18 点数据。要验证这一点：</p>
<figure class="highlight ruby"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ruby">vector(time())[24<span class="hljs-symbol">h:</span>2h] <span class="hljs-comment"># 当前是 08:01</span><br><span class="hljs-comment"># 结果：</span><br><span class="hljs-comment"># 1719396000 @1719396000 </span><br><span class="hljs-comment"># 1719403200 @1719403200</span><br><span class="hljs-comment"># 1719410400 @1719410400</span><br><span class="hljs-comment"># 1719417600 @1719417600</span><br><span class="hljs-comment"># 1719424800 @1719424800</span><br><span class="hljs-comment"># 1719432000 @1719432000</span><br><span class="hljs-comment"># 1719439200 @1719439200</span><br><span class="hljs-comment"># 1719446400 @1719446400</span><br><span class="hljs-comment"># 1719453600 @1719453600</span><br><span class="hljs-comment"># 1719460800 @1719460800 04:00</span><br><span class="hljs-comment"># 1719468000 @1719468000 06:00</span><br><span class="hljs-comment"># 1719475200 @1719475200 08:00</span><br></code></pre></div></td></tr></table></figure>

<p><strong>对齐的方式似乎是从 1970 年 1 月 1 日开始去按步长走，得到最接近当前时间的时间戳并以它作为最后一个时间戳，然后按步长往前走。</strong></p>
<p>比如，当前是 1719475581（2024-06-27 08:06:21），设置步长为<code>1h1m1s</code>，即<code>3661</code>，最近的时间戳为 <code>1719475581 - 1719475581 % 3661 = 1719472853（2024-06-27 07:20:53）</code>。</p>
<p>因此，步长设置为<code>6h</code>时，最近的小时数会是 0、6、12、18，步长设置为<code>24h</code>或<code>1d</code>时，最近的小时数会是 0，即每日开始时间，因此<code>[1d:1d]</code>取得的就是本日开始时间。</p>
<p>步长设置为更长，如<code>1w</code>时也是如此。</p>
<h2 id="vector-matching"><a href="#vector-matching" class="headerlink" title="vector matching"></a>vector matching</h2><p>TODO <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching-keywords">https://prometheus.io/docs/prometheus/latest/querying/operators/#vector-matching-keywords</a></p>
<h3 id="group-修饰符"><a href="#group-修饰符" class="headerlink" title="group 修饰符"></a>group 修饰符</h3><p>TODO…</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>TODO</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Prometheus/">Prometheus</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-NC-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/08-25%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2SD%E5%92%8Cseamless_communication.html">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">本地部署 Stable Diffusion WebUI 和 Facebook 的 seamless_communication</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/06-25Rubick%E6%8F%92%E4%BB%B6%E7%BC%96%E5%86%99%E7%AC%94%E8%AE%B0.html">
                        <span class="hidden-mobile">Rubick 插件学习笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>





  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<!-- hexo injector body_end start -->
<script src="/assets/prism-bundle.js"></script>
<script src="/assets/prism-plus.js" data-pjax=""></script>
<!-- hexo injector body_end end --></body>
</html>
