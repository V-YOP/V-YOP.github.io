

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="友纪V-λOP">
  <meta name="keywords" content="">
  
    <meta name="description" content="气分转换">
<meta property="og:type" content="article">
<meta property="og:title" content="Rust sokoban 学习笔记">
<meta property="og:url" content="http://example.com/2024/02-13Rust%E6%8E%A8%E7%AE%B1%E5%AD%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/02-13Rust%E6%8E%A8%E7%AE%B1%E5%AD%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">
<meta property="og:site_name" content="友纪V-λOP">
<meta property="og:description" content="气分转换">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2024/02-13Rust%E6%8E%A8%E7%AE%B1%E5%AD%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-2.png">
<meta property="article:published_time" content="2024-02-13T10:00:00.000Z">
<meta property="article:modified_time" content="2024-03-15T23:53:19.080Z">
<meta property="article:author" content="友纪V-λOP">
<meta property="article:tag" content="游戏开发">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2024/02-13Rust%E6%8E%A8%E7%AE%B1%E5%AD%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-2.png">
  
  
  <title>Rust sokoban 学习笔记 - 友纪V-λOP</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/atom-one-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss2.xml" title="友纪V-λOP" type="application/rss+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>友纪V-λOP的blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Rust sokoban 学习笔记">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2024-02-13 18:00" pubdate>
        2024年2月13日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11k 字
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Rust sokoban 学习笔记</h1>
            
            <div class="markdown-body">
              <p>n2t 学好累，找点新玩具玩玩，闻闻味儿，找点乐子，etc… 参考 <a target="_blank" rel="noopener" href="https://sokoban.iolivia.me">https://sokoban.iolivia.me</a>。</p>
<p>虽然只是找点乐子，但确实学到了点东西，把 rust 的模块化熟悉了一下，了解了一下 ECS，见识了一下 Rust 的框架的抽象能做到何种程度（在类型的花活上简直比隔壁 ts 还牛逼……），必可活用于下一次。</p>
<h1 id="ECS"><a href="#ECS" class="headerlink" title="ECS"></a>ECS</h1><p>ECS，即 Entity-Component System，是一种游戏架构模式，它遵循组合优于继承的原则：</p>
<ul>
<li>Component：持有实体的特定特征的<strong>纯数据</strong>结构，比如位置，是否可渲染，移动</li>
<li>Entity：Entity 由复数的 Component 组成，比如玩家可能包括位置，是否可渲染，移动等 Component，地面可能只包括位置和是否可渲染。Entity 差不多只是一个有着唯一标识符（似乎也是通过 Component 去标识，这些 Component 称为 Marker Component，不包含任何数据）的 Component 的容器</li>
<li>System：System 使用 Component 和 Entity，并包含利用这些数据的行为和逻辑。比如，一个渲染 System 可能会迭代所有可渲染（即包含相应 Component）的 Entity 并绘制它们。<strong>只有 System 包含行为</strong>，Component 利用 System 去执行操作（就像 Visitor）</li>
</ul>
<p>推箱子游戏中包含如下 Entity，以及这些 Entity 由什么 Component 组成（把 Component 当成“配置”或字段？）</p>
<ul>
<li>Player: Position, Renderable, Movable</li>
<li>Wall: Position, Renderable</li>
<li>Floor: Position, Renderable</li>
<li>Box: Position, Renderable, Movable</li>
<li>Box spot（箱子的目标位置）: Position, Renderable</li>
</ul>
<p>这书使用了下面的库：</p>
<ul>
<li>ggez：一个 2D 游戏引擎，负责一些底层的玩意——绘制窗口，事件循环……</li>
<li>specs：ECS 库，所有业务都在这儿了（ECS 和游戏引擎是分开的，这点有点酷，也就是说能用其它的架构模式去料理这个游戏引擎）</li>
<li>glam：一个 3D 绘图库，用这玩意去绘图</li>
</ul>
<p>跟着写代码的时候时刻区分哪些部分是 ggez 的，哪些部分是 specs 的，这还蛮有趣的，似乎是第一次把两个轮子结合在一起去做点什么，之前都是只借助内置库以及一个轮子。</p>
<h1 id="定义-Component-和-Entity"><a href="#定义-Component-和-Entity" class="headerlink" title="定义 Component 和 Entity"></a>定义 Component 和 Entity</h1><p>之前学习迭代器的时候看到它的 collect 就很好奇它的实现方式，现在又看到相似的用法了。这玩意实际上实现上没有任何动态的部分——它接受一个实现特定 trait 的类型，在编译时直接找到相应 trait 的实现。这和 java 中的类似玩意不一样，那个需要利用上反射（根本原因是 Java 的接口和抽象类无法对 static 方法进行约束）或者得把相应方法引用给传进去。</p>
<p>下面是注册 Component，以及对 Entity 的定义，<strong>注意 Entity 并非是以类型的形式去定义，这允许 Entity 在运行时以及通过配置文件等方式去修改</strong>，况且使用类型去定义的话反而更麻烦，System 无法轻易找到哪些 Entity 包含它要的 Component：</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Debug, Component, Clone, Copy)]</span><br><span class="hljs-meta">#[storage(VecStorage)]</span> <span class="hljs-comment">// 这个似乎是说所有 Component 存储的方式</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Position</span> &#123;<br>    x: <span class="hljs-type">u8</span>,<br>    y: <span class="hljs-type">u8</span>,<br>    z: <span class="hljs-type">u8</span>, <span class="hljs-comment">// 用于确定谁显示在前面</span><br>&#125;<br><span class="hljs-comment">// 其他 Component……</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">register_components</span>(world: &amp;<span class="hljs-keyword">mut</span> World) &#123;<br>    world.register::&lt;Position&gt;();<br>    world.register::&lt;Renderable&gt;();<br>    <span class="hljs-comment">// 下面的都是 Marker Component</span><br>    world.register::&lt;Player&gt;();<br>    world.register::&lt;Wall&gt;();<br>    world.register::&lt;<span class="hljs-type">Box</span>&gt;();<br>    world.register::&lt;BoxSpot&gt;();<br>&#125;<br><span class="hljs-comment">// Wall Entity 定义</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">create_wall</span>(world: &amp;<span class="hljs-keyword">mut</span> World, position: Position) &#123;<br>    world<br>        .<span class="hljs-title function_ invoke__">create_entity</span>()<br>        .<span class="hljs-title function_ invoke__">with</span>(Position &#123; z: <span class="hljs-number">10</span>, ..position &#125;)<br>        .<span class="hljs-title function_ invoke__">with</span>(Renderable &#123;<br>            path: <span class="hljs-string">&quot;/images/wall.png&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>(),<br>        &#125;)<br>        .<span class="hljs-title function_ invoke__">with</span>(Wall &#123;&#125;)<br>        .<span class="hljs-title function_ invoke__">build</span>();<br>&#125;<br><span class="hljs-comment">// 其他 Entity</span><br></code></pre></div></td></tr></table></figure>
<h1 id="Rendering-System"><a href="#Rendering-System" class="headerlink" title="Rendering System"></a>Rendering System</h1><p>开始定义 System，System 需要能够修改外界事物，因此需要包含 Context——ggez 提供的用于操作游戏状态的接口，以可变借用的形式。</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RenderingSystem</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; &#123;<br>    context: &amp;<span class="hljs-symbol">&#x27;a</span> <span class="hljs-keyword">mut</span> Context,<br>&#125;<br><br><span class="hljs-comment">// Rendering System 需要知道 Component 的位置和是否可渲染。有此二 Component 的 Entity 才能被渲染</span><br><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; System&lt;<span class="hljs-symbol">&#x27;a</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">RenderingSystem</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; &#123;<br>    <span class="hljs-comment">// 这里的 ReadStorage 就是 Component 的集合，只读的显然</span><br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">SystemData</span> = (ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Position&gt;, ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Renderable&gt;);<br><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, data: <span class="hljs-keyword">Self</span>::SystemData) &#123;<br>        <span class="hljs-keyword">let</span> (positions, renderables) = data;<br>        <span class="hljs-comment">// todo...</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>然后，其业务就可以加到事件循环中了（每次循环都创建一次……但这玩意其实确实挺便宜）：</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">event</span>::EventHandler&lt;ggez::GameError&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">Game</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, context: &amp;<span class="hljs-keyword">mut</span> Context) <span class="hljs-punctuation">-&gt;</span> GameResult &#123;<br>        &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rs</span> = RenderingSystem &#123; context &#125;;<br>            rs.<span class="hljs-title function_ invoke__">run_now</span>(&amp;<span class="hljs-keyword">self</span>.world);<br>        &#125;<br>        <span class="hljs-title function_ invoke__">Ok</span>(())<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>关于 Rendering System 的业务：</p>
<ol>
<li>清空（上一帧）屏幕</li>
<li>获取所有 Position 和 Renderable（同时包含这两个 Component 的 Entity？），按 z 轴排序</li>
<li>根据 Renderable 中存储的路径加载图片，在 Position 中的相应位置绘制图片</li>
<li>展示图片</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-comment">// Rendering System 需要知道 Entity 的位置和是否可渲染。有此二 Component 的 Entity 才能被渲染</span><br><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; System&lt;<span class="hljs-symbol">&#x27;a</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">RenderingSystem</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; &#123;<br>    <span class="hljs-comment">// SystemData 即该 System 需要知晓的东西，这里规定需要知晓 Renderable 和 Position（及拥有这两个 Component 的 Entity）</span><br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">SystemData</span> = (ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Position&gt;, ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Renderable&gt;);<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, data: <span class="hljs-keyword">Self</span>::SystemData) &#123;<br>        <span class="hljs-keyword">let</span> (positions, renderables) = data;<br>        <span class="hljs-comment">// 清空上一帧（注意这里并非是直接操作 context，可能 context 中均是底层和原子的操作）</span><br>        graphics::<span class="hljs-title function_ invoke__">clear</span>(<span class="hljs-keyword">self</span>.context, graphics::Color::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0.95</span>, <span class="hljs-number">0.95</span>, <span class="hljs-number">0.95</span>, <span class="hljs-number">1.0</span>));<br>        <span class="hljs-comment">// join 操作保证得到的集合中，每个元素都是这样的 Entity 的这些 Component，它同时包含这些 Component</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">entities</span> = (&amp;positions, &amp;renderables).<span class="hljs-title function_ invoke__">join</span>().collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;();<br>        entities.<span class="hljs-title function_ invoke__">sort_by_key</span>(|(p, _)| p.z);<br>        <span class="hljs-keyword">for</span> (position, renderable) <span class="hljs-keyword">in</span> entities &#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">image</span> = Image::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-keyword">self</span>.context, &amp;renderable.path).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;expected image&quot;</span>);<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = position.x <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span> * TILE_WIDTH;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">y</span> = position.y <span class="hljs-keyword">as</span> <span class="hljs-type">f32</span> * TILE_WIDTH; <br>            <span class="hljs-keyword">let</span> <span class="hljs-variable">draw_params</span> = DrawParam::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">dest</span>(Vec2::<span class="hljs-title function_ invoke__">new</span>(x, y));<br>            graphics::<span class="hljs-title function_ invoke__">draw</span>(<span class="hljs-keyword">self</span>.context, &amp;image, draw_params).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;expected render&quot;</span>);<br>        &#125;<br>        graphics::<span class="hljs-title function_ invoke__">present</span>(<span class="hljs-keyword">self</span>.context).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;expected to present&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><img src="image-2.png" alt="alt text"></p>
<h1 id="Input-Event，Resource"><a href="#Input-Event，Resource" class="headerlink" title="Input Event，Resource"></a>Input Event，Resource</h1><p>该动起来了。要移动 Player，需要捕获输入事件，并通知 specs 去进行处理。</p>
<p>要捕获输入事件，只需要“重写”<code>key_down_event</code>即可：</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">key_down_event</span>(<br>        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,<br>        ctx: &amp;<span class="hljs-keyword">mut</span> Context,<br>        keycode: event::KeyCode,<br>        _keymods: event::KeyMods,<br>        _repeat: <span class="hljs-type">bool</span>,<br>    ) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Key pressed: &#123;:?&#125;&quot;</span>, keycode);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>如何去通知 specs 去处理呢？specs 中有一种名为 Resource 的概念，Resource 是可全局共享的数据或服务，它不属于任何单个 Entity，可被一个或多个 System 去使用。可以把键盘输入作为一种可全局访问的数据，即作为 Resource。另外的典型 Resource 包括游戏配置。实际上屏幕也可以作为 Resource…</p>
<p>要定义一个 Resource，只需要将其“注册”进去即可，这里虽然说是注册，但实际上是插了个实例。这玩意让我想到 React 的 Provider。</p>
<p>这时候就要问了——卧槽<code>write_resource</code>是怎么根据泛型得到我要的类型的资源的实例的？实际上有个<code>TypeId::of::&lt;T&gt;()</code>方法能获取<code>T</code>的 typeId，即该类型的唯一标识符，得到了标识符便能够得到实例，就像某种依赖注入。</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-meta">#[derive(Default)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InputQueue</span> &#123;<br>    <span class="hljs-keyword">pub</span> keys_pressed: <span class="hljs-type">Vec</span>&lt;KeyCode&gt;,<br>&#125;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">register_resources</span>(world: &amp;<span class="hljs-keyword">mut</span> World) &#123;<br>    world.<span class="hljs-title function_ invoke__">insert</span>(InputQueue::<span class="hljs-title function_ invoke__">default</span>())<br>&#125;<br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">key_down_event</span>(<br>        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>,<br>        ctx: &amp;<span class="hljs-keyword">mut</span> Context,<br>        keycode: KeyCode,<br>        _keymods: KeyMods,<br>        _repeat: <span class="hljs-type">bool</span>,<br>    ) &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Key pressed: &#123;:?&#125;&quot;</span>, keycode);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">input_queue</span> = <span class="hljs-keyword">self</span>.world.write_resource::&lt;InputQueue&gt;();<br>    input_queue.keys_pressed.<span class="hljs-title function_ invoke__">push</span>(keycode);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h1 id="Input-System"><a href="#Input-System" class="headerlink" title="Input System"></a>Input System</h1><p>Rendering System 只读取 Component，但 Input System 需要读取 Component 和 Resource，然后写 Component。一个很酷的地方是，Input System 不需要拥有任何字段，它只负责根据输入去更新 Player 的 Movement 即可。Rendering System 的业务放到 update 过程中。</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InputSystem</span> &#123;&#125;<br><br><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; System&lt;<span class="hljs-symbol">&#x27;a</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">InputSystem</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">SystemData</span> = (<br>        <span class="hljs-comment">// 它要读写 InputQueue</span><br>        Write&lt;<span class="hljs-symbol">&#x27;a</span>, InputQueue&gt;,<br>        <span class="hljs-comment">// 它要读写 Position</span><br>        WriteStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Position&gt;,<br>        <span class="hljs-comment">// 它要读 Player 以确定谁是 Player</span><br>        ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Player&gt;<br>    );<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, data: <span class="hljs-keyword">Self</span>::SystemData) &#123;<br>        <span class="hljs-keyword">let</span> (<span class="hljs-keyword">mut</span> input_queue, <span class="hljs-keyword">mut</span> position, players) = data;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(key) = input_queue.keys_pressed.<span class="hljs-title function_ invoke__">pop</span>() <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;;<br>        <span class="hljs-keyword">for</span> (Position &#123; x, y, .. &#125;, _) <span class="hljs-title function_ invoke__">in</span> (&amp;<span class="hljs-keyword">mut</span> position, &amp;players).<span class="hljs-title function_ invoke__">join</span>() &#123;<br>            <span class="hljs-keyword">match</span> key &#123;<br>                KeyCode::Up =&gt; *y -= <span class="hljs-number">1</span>,<br>                KeyCode::Down =&gt; *y += <span class="hljs-number">1</span>,<br>                KeyCode::Left =&gt; *x -= <span class="hljs-number">1</span>,<br>                KeyCode::Right =&gt; *x += <span class="hljs-number">1</span>,<br>                _ =&gt; ()<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">update</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, context: &amp;<span class="hljs-keyword">mut</span> Context) <span class="hljs-punctuation">-&gt;</span> GameResult &#123;<br>    <span class="hljs-comment">// Run input system</span><br>    &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">is</span> = InputSystem &#123;&#125;;<br>        is.<span class="hljs-title function_ invoke__">run_now</span>(&amp;<span class="hljs-keyword">self</span>.world);<br>    &#125;<br>    <span class="hljs-title function_ invoke__">Ok</span>(())<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>System 有点像策略，它本身不持有 World，而是接受 World 去做操作，因此动态地增减 System 是轻松的，World 也不需要知道当前有多少个 System 还在活跃。所以这又是一个取舍……</p>
<h1 id="推箱子"><a href="#推箱子" class="headerlink" title="推箱子"></a>推箱子</h1><p>当前 Player 能到处动了，但和环境没有任何交互，会穿过墙壁和箱子。为此需要添加相应业务。考虑再定义两个 Marker，标识 Entity 可以被移动和无法被移动；Player 和箱子是可以被移动的，而墙壁无法被移动；<strong>其它的部分和移动功能无关，因此不进行任何标识</strong>。</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-comment">// 没有任何字段时可以使用 NullStorage，尚不知这玩意本质</span><br><span class="hljs-meta">#[derive(Component, Default)]</span><br><span class="hljs-meta">#[storage(NullStorage)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Movable</span>;<br><br><span class="hljs-meta">#[derive(Component, Default)]</span><br><span class="hljs-meta">#[storage(NullStorage)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Immovable</span>;<br><br><span class="hljs-comment">// 为 Player 和 Box with Movable</span><br><span class="hljs-comment">// 为 Wall with Immovable</span><br></code></pre></div></td></tr></table></figure>
<p>然后就是修改 InputSystem 去添加相应逻辑了，这里允许推动多个箱子（要头疼啦），其它的规则大家都知道。主要逻辑大概是检查移动方向上的所有物体，找到连续的 Movable（包括 Player），然后看尾随的是否是 Immovable，如果不是，就移动这所有的 Movable，否则谁都动不了。</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; System&lt;<span class="hljs-symbol">&#x27;a</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">InputSystem</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">SystemData</span> = (<br>        <span class="hljs-comment">// 它要读写 InputQueue</span><br>        Write&lt;<span class="hljs-symbol">&#x27;a</span>, InputQueue&gt;,<br>        <span class="hljs-comment">// 它要读 Entity 以知晓其 id</span><br>        Entities&lt;<span class="hljs-symbol">&#x27;a</span>&gt;,<br>        <span class="hljs-comment">// 它要读写 Position</span><br>        WriteStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Position&gt;,<br>        <span class="hljs-comment">// 它要读 Player 以确定谁是 Player</span><br>        ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Player&gt;,<br>        <span class="hljs-comment">// 它要读 Movable，确认谁是可以被移动的以推动它</span><br>        ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Movable&gt;,<br>        <span class="hljs-comment">// 它要读 Immovable，确认何时无法推动</span><br>        ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Immovable&gt;,<br>    );<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, data: <span class="hljs-keyword">Self</span>::SystemData) &#123;<br>        <span class="hljs-keyword">let</span> (<span class="hljs-keyword">mut</span> input_queue, entities, <span class="hljs-keyword">mut</span> positions, players, movable, immovable) = data;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(key) = input_queue.keys_pressed.<span class="hljs-title function_ invoke__">pop</span>() <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">direction</span> = <span class="hljs-keyword">match</span> key &#123;<br>            KeyCode::Up =&gt; (<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>),<br>            KeyCode::Down =&gt; (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>            KeyCode::Left =&gt; (-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>),<br>            KeyCode::Right =&gt; (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>),<br>            _ =&gt; <span class="hljs-keyword">return</span><br>        &#125;;<br>        <span class="hljs-comment">// 找到所有的 Movable 和 Immovable 的 Entity，按坐标-&gt;entityId 去建立索引</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">mov</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">immov</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">for</span> (entity, &amp;Position &#123; x, y, .. &#125;, _) <span class="hljs-title function_ invoke__">in</span> (&amp;entities, &amp;positions, &amp;movable).<span class="hljs-title function_ invoke__">join</span>() &#123;<br>            mov.<span class="hljs-title function_ invoke__">insert</span>((x, y), entity.<span class="hljs-title function_ invoke__">id</span>());<br>        &#125;<br>        <span class="hljs-keyword">for</span> (entity, &amp;Position &#123; x, y, .. &#125;, _) <span class="hljs-title function_ invoke__">in</span> (&amp;entities, &amp;positions, &amp;immovable).<span class="hljs-title function_ invoke__">join</span>() &#123;<br>            immov.<span class="hljs-title function_ invoke__">insert</span>((x, y), entity.<span class="hljs-title function_ invoke__">id</span>());<br>        &#125;<br>        <span class="hljs-keyword">let</span> (&amp;Position &#123; x, y, .. &#125;, _) = (&amp;positions, &amp;players).<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;No Player Component&quot;</span>);<br><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">to_move</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">pos</span> <span class="hljs-keyword">in</span> std::iter::<span class="hljs-title function_ invoke__">successors</span>(<span class="hljs-title function_ invoke__">Some</span>((x, y)), |&amp;(x, y)| <span class="hljs-title function_ invoke__">Some</span>((x + direction.<span class="hljs-number">0</span>, y + direction.<span class="hljs-number">1</span>)))<br>                    .<span class="hljs-title function_ invoke__">take_while</span>(|&amp;(x, y)| x &gt;= <span class="hljs-number">0</span> &amp;&amp; x <span class="hljs-keyword">as</span> <span class="hljs-type">u16</span> &lt;= MAP_WIDTH &amp;&amp; y &gt;= <span class="hljs-number">0</span> &amp;&amp; y <span class="hljs-keyword">as</span> <span class="hljs-type">u16</span> &lt;= MAP_HEIGHT) &#123;<br>            <span class="hljs-comment">// 从 player 出发，往移动方向看</span><br>            <span class="hljs-comment">// 如果遇到 mov，加到待 move 的集合中</span><br>            <span class="hljs-comment">// 如果遇到 immov，证明有墙壁直接相连，谁都动不了，直接返回</span><br>            <span class="hljs-comment">// 如果遇到既不 mov 又不 immov 的，证明有空隙，可以动</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(entity_id) = mov.<span class="hljs-title function_ invoke__">get</span>(&amp;pos) &#123;<br>                to_move.<span class="hljs-title function_ invoke__">push</span>(*entity_id)<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(_) = immov.<span class="hljs-title function_ invoke__">get</span>(&amp;pos) &#123;<br>                <span class="hljs-keyword">return</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">break</span><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">entity_id</span> <span class="hljs-keyword">in</span> to_move &#123;<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-variable">Some</span>(pos) = positions.<span class="hljs-title function_ invoke__">get_mut</span>(entities.<span class="hljs-title function_ invoke__">entity</span>(entity_id)) &#123;<br>                pos.x = pos.x + direction.<span class="hljs-number">0</span>;<br>                pos.y = pos.y + direction.<span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h1 id="模块化"><a href="#模块化" class="headerlink" title="模块化"></a>模块化</h1><p>前面所有代码全写在<code>main.rs</code>中，为了方便维护，应按照关注点分离原则去分离代码。这里旨在感受一下 rust 的模块化。对项目内的代码，每个 rs 文件都是从它自己出发去引用其它 rs 文件（模块）：</p>
<p>（没细学，瞎 BB 的！）</p>
<ul>
<li>解析从<code>main.rs</code>或<code>lib.rs</code>开始，它们是命名空间的根路径，即<code>crate::</code>，这两个文件中能直接看到的顶层成员，通过<code>crate::</code>都能看到，无论它是否加了 pub；另外使用<code>self::</code>表示当前目录（这似乎是默认行为）</li>
<li>每个 rs 文件中可以使用<code>[pub] mod MODULE_NAME &#123;/* ... */&#125;</code>去定义新的模块，或者使用<code>[pub] mod MODULE_NAME;</code>去“声明”新的模块，rustc 会从<code>./MODULE_NAME.rs</code>或<code>./MODULE_NAME/mod.rs</code>中找模块的实际定义；如果 mod 前缀 pub，则它是 public 的，能被外界访问到，这点对<code>main.rs</code>和<code>lib.rs</code>不适用</li>
<li>使用<code>pub use</code>可以进行“重新导出”，允许越过模块结构，直接从当前模块中导出其它模块，主要是嵌套子模块中的成员，比如这里在<code>/systems/mod.rs</code>中编写了<code>mod input_system; pub use input_system::InputSystem</code>，<code>main.rs</code>中就可以直接通过<code>systems::InputStream</code>去导入<code>InputStream</code>，这允许对模块结构进行抽象</li>
</ul>
<h1 id="gameplay"><a href="#gameplay" class="headerlink" title="gameplay"></a>gameplay</h1><p>能动了，自由了，但没有目标，仍旧是带着锁链。该为这游戏设立点目标了。目标是显然的——以最小的步数把所有箱子移动到目标位置，为此，需要记录步数，需要检查箱子是否移动到目标位置。</p>
<p>步数，以及当前是否完成游戏，这显然是一个全局的数据，可以使用 Resource 去抽象它。InputSystem 需要读写它——如果游戏没有完成，自增步数，另外需要一个 GamePlayStateSystem——包含关于游戏完成状态的逻辑——去读写它：变更当前游戏完成状态。</p>
<p>两个实体在读写同一个数据…设计上是在<code>update</code>阶段先执行 InputStream 的逻辑，再执行 GameStateSystem 的逻辑所以没啥问题，在工业级的游戏中也会是这样有严格的顺序执行的吗？如果不是，那就不能这么操作了，考虑到一些并发问题啥的。猜测工业级的游戏中如果要实现类似功能，应该是使用某种发布订阅模式去通知 Player 有移动，而不是让 InputSystem 去进行操作——我只负责动，其它的关我屁事。</p>
<p>GamePlayStateSystem 需要读写游戏状态，需要读 Box，BoxSpot 和 Position 以确认箱子是否是在目标处：</p>
<figure class="highlight rust"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs rust"><span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt; System&lt;<span class="hljs-symbol">&#x27;a</span>&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">GameplayStateSystem</span> &#123;<br>    <span class="hljs-keyword">type</span> <span class="hljs-title class_">SystemData</span> = (<br>        Write&lt;<span class="hljs-symbol">&#x27;a</span>, Gameplay&gt;,<br>        ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, Position&gt;,<br>        ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, <span class="hljs-type">Box</span>&gt;,<br>        ReadStorage&lt;<span class="hljs-symbol">&#x27;a</span>, BoxSpot&gt;,<br>    );<br>    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">run</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, data: <span class="hljs-keyword">Self</span>::SystemData) &#123;<br>        <span class="hljs-keyword">let</span> (<span class="hljs-keyword">mut</span> gameplay, positions, boxes, box_spots) = data;<br>        <span class="hljs-comment">// 首先获取所有 Box 的位置</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">box_pos</span> = (&amp;positions, &amp;boxes).<span class="hljs-title function_ invoke__">join</span>()<br>            .<span class="hljs-title function_ invoke__">map</span>(|(&amp;Position &#123; x, y, .. &#125;, _)| (x, y)).collect::&lt;HashSet&lt;_&gt;&gt;();<br>        <span class="hljs-comment">// 然后检查所有 Box 都在 Spot 上</span><br>        <span class="hljs-keyword">if</span> (&amp;positions, &amp;box_spots).<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">map</span>(|x| x.<span class="hljs-number">0</span>)<br>            .<span class="hljs-title function_ invoke__">all</span>(|&amp;Position &#123; x, y, .. &#125;| box_pos.<span class="hljs-title function_ invoke__">contains</span>(&amp;(x, y))) &#123;<br>            gameplay.state = GameplayState::Won<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>然后要绘制当前的游戏状态到屏幕上，因此 Rendering System 需要读取游戏状态。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/">游戏开发</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-NC-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/02-17%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E8%A6%81%E7%B4%A0%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0Part3%E2%80%94%E2%80%94%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%8C%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90/index.html">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">计算机系统要素学习笔记 Part3——编译器和代码生成</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/02-13Rust%E6%8E%A8%E7%AE%B1%E5%AD%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
                        <span class="hidden-mobile">Rust sokoban 学习笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>





  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<!-- hexo injector body_end start -->
<script src="/assets/prism-bundle.js"></script>
<script src="/assets/prism-plus.js" data-pjax=""></script>
<!-- hexo injector body_end end --></body>
</html>
